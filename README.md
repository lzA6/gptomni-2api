# gptomni-2api: æ‚¨çš„ç§äºº GPT-Omni to OpenAI API è½¬æ¢å™¨ ğŸ¤–âœ¨

[![License: Apache 2.0](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)
[![GitHub stars](https://img.shields.io/github/stars/lzA6/gptomni-2api?style=social)](https://github.com/lzA6/gptomni-2api/stargazers)
[![Docker Build](https://img.shields.io/badge/Docker-Build%20Ready-blue?logo=docker)](https://github.com/lzA6/gptomni-2api/blob/main/Dockerfile)

**ä¸­æ–‡** | [English](https://github.com/lzA6/gptomni-2api) (å³å°†æ¨å‡º)

> "æˆ‘ä»¬ä¸æ˜¯åœ¨ç¼–å†™ä»£ç ï¼Œæˆ‘ä»¬æ˜¯åœ¨ç”¨é€»è¾‘å’Œæƒ³è±¡åŠ›ï¼Œä¸ºä¸–ç•Œå¢æ·»ä¸€æŠ¹æ–°çš„å¯èƒ½æ€§ã€‚æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œéƒ½æ˜¯å¯¹æœªæ¥çš„ä¸€æ¬¡æŠ•ç¥¨ã€‚" - A.I. Philosopher

æ¬¢è¿æ¥åˆ° `gptomni-2api` çš„ä¸–ç•Œï¼è¿™æ˜¯ä¸€ä¸ªç®€å•ã€é«˜æ•ˆã€ä¸”å……æ»¡é­”åŠ›çš„é¡¹ç›®ï¼Œå®ƒèƒ½å°† [GPT-Omni](https://gptomni.ai) çš„ç½‘é¡µæœåŠ¡ï¼Œå¥‡è¿¹èˆ¬åœ°è½¬æ¢æˆä¸€ä¸ªå®Œå…¨å…¼å®¹ [OpenAI API](https://platform.openai.com/docs/api-reference) æ ¼å¼çš„æ¥å£ã€‚

è¿™æ„å‘³ç€ï¼Œæ‚¨å¯ä»¥å°†ä»»ä½•æ”¯æŒ OpenAI API çš„å®¢æˆ·ç«¯æˆ–åº”ç”¨ï¼ˆæ¯”å¦‚å„ç§æ¡Œé¢å®¢æˆ·ç«¯ã€èŠå¤©æœºå™¨äººã€è‡ªåŠ¨åŒ–è„šæœ¬ç­‰ï¼‰ï¼Œæ— ç¼å¯¹æ¥åˆ° `gptomni.ai` çš„å¼ºå¤§èƒ½åŠ›ä¸Šï¼

**ä»“åº“é“¾æ¥**: [https://github.com/lzA6/gptomni-2api](https://github.com/lzA6/gptomni-2api)

---

## ğŸŒŸ é¡¹ç›®äº®ç‚¹

*   **âœ¨ å…¼å®¹ä¸‡ç‰©**: åªè¦æ˜¯æ”¯æŒ OpenAI `v1/chat/completions` æ¥å£çš„åº”ç”¨ï¼Œéƒ½èƒ½ç«‹åˆ»ä½¿ç”¨æœ¬é¡¹ç›®ã€‚æ— éœ€ä»»ä½•ä¿®æ”¹ï¼Œå³æ’å³ç”¨ï¼
*   **ğŸš€ ä¸€é”®éƒ¨ç½²**: å€ŸåŠ© Docker å’Œ Docker Composeï¼Œæ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹å°±åƒæ³¡ä¸€æ¯å’–å•¡ä¸€æ ·ç®€å•ã€‚å¯¹æ–°æ‰‹æå…¶å‹å¥½ï¼
*   **ğŸ”„ æ™ºèƒ½è½®è¯¢**: æ”¯æŒé…ç½®å¤šä¸ª `gptomni.ai` è´¦å·çš„ Cookieã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è½®æµä½¿ç”¨ï¼Œå¤§å¤§æé«˜äº†æœåŠ¡çš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§ã€‚
*   **ğŸ›¡ï¸ ç”Ÿäº§çº§æ¶æ„**: å†…ç½® Nginx ä½œä¸ºåå‘ä»£ç†ï¼Œå®ç°äº†è´Ÿè½½å‡è¡¡å’Œæµå¼ä¼ è¾“ä¼˜åŒ–ï¼Œç¡®ä¿äº†é«˜æ€§èƒ½å’Œé«˜ç¨³å®šæ€§ã€‚
*   **ğŸ’¨ é«˜æ•ˆæµå¼ä¼ è¾“**: å®ç°äº†çœŸæ­£çš„æµå¼å“åº”ï¼ˆSSEï¼‰ï¼Œæ‰“å­—æœºæ•ˆæœä¸æ»‘æµç•…ï¼Œä½“éªŒä¸å®˜æ–¹ API åˆ«æ— äºŒè‡´ã€‚
*   **ğŸ’– å¼€æºä¸è‡ªç”±**: é‡‡ç”¨ Apache 2.0 åè®®ï¼Œæ‚¨å¯ä»¥è‡ªç”±åœ°ä½¿ç”¨ã€ä¿®æ”¹å’Œåˆ†å‘ã€‚

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```mermaid
graph TB
    Client[å®¢æˆ·ç«¯åº”ç”¨] --> Nginx[Nginx åå‘ä»£ç†]
    Nginx --> App1[Python App å®ä¾‹ 1]
    Nginx --> App2[Python App å®ä¾‹ 2]
    
    App1 --> CM[å‡­è¯ç®¡ç†å™¨]
    App2 --> CM
    
    CM --> Cookie1[è´¦å· Cookie 1]
    CM --> Cookie2[è´¦å· Cookie 2]
    CM --> Cookie3[è´¦å· Cookie 3]
    
    App1 --> GPT[gptomni.ai]
    App2 --> GPT
    
    subgraph "gptomni-2api ç³»ç»Ÿ"
        Nginx
        App1
        App2
        CM
    end
```

---

## ğŸ¤” æ ¸å¿ƒåŸç†æ­ç§˜

### 1. **ä¼ªè£…æˆæµè§ˆå™¨**
- ä½¿ç”¨ `cloudscraper` Python åº“æ¨¡æ‹ŸçœŸå®æµè§ˆå™¨è¡Œä¸º
- ç»•è¿‡ Cloudflare ç­‰é˜²æŠ¤æœºåˆ¶
- **æŠ€æœ¯ç‚¹**: `cloudscraper` åº“ + HTTP å¤´ä¼ªè£…

### 2. **åè®®è½¬æ¢**
- æ¥æ”¶æ ‡å‡† OpenAI API è¯·æ±‚
- æå–å…³é”®ä¿¡æ¯å¹¶è½¬æ¢ä¸º gptomni.ai æ ¼å¼
- **æŠ€æœ¯ç‚¹**: FastAPI è¯·æ±‚è§£æ + æ•°æ®æ ¼å¼æ˜ å°„

### 3. **å®æ—¶æµå¼ä¼ è¾“**
- å®æ—¶æ¥æ”¶ gptomni.ai çš„æµå¼å“åº”
- è½¬æ¢ä¸º OpenAI å…¼å®¹çš„ SSE æ ¼å¼
- **æŠ€æœ¯ç‚¹**: StreamingResponse + SSE åè®®

### 4. **æ™ºèƒ½è´Ÿè½½å‡è¡¡**
- å¤š Cookie è½®è¯¢ä½¿ç”¨
- çº¿ç¨‹å®‰å…¨çš„å‡­è¯ç®¡ç†
- **æŠ€æœ¯ç‚¹**: threading.Lock + è½®è¯¢ç®—æ³•

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ææ¡ä»¶
- [Docker](https://www.docker.com/get-started) 
- [Docker Compose](https://docs.docker.com/compose/install/)

### éƒ¨ç½²æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
```bash
git clone https://github.com/lzA6/gptomni-2api.git
cd gptomni-2api
```

2. **é…ç½®ç¯å¢ƒå˜é‡**
```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶
```

3. **è·å–å¹¶é…ç½® Cookie**
   - ç™»å½• [gptomni.ai](https://gptomni.ai)
   - æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
   - åˆ‡æ¢åˆ° Network æ ‡ç­¾é¡µ
   - å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæ‰¾åˆ° `chatWithText` è¯·æ±‚
   - å¤åˆ¶ Request Headers ä¸­çš„ `cookie` å€¼

**å•è´¦å·é…ç½®:**
```env
GPTOMNI_CREDENTIALS='["ä½ çš„å®Œæ•´Cookieå­—ç¬¦ä¸²"]'
```

**å¤šè´¦å·é…ç½® (æ¨è):**
```env
GPTOMNI_CREDENTIALS='["cookie1", "cookie2", "cookie3"]'
API_MASTER_KEY=sk-your-super-secret-key
NGINX_PORT=8088
```

4. **å¯åŠ¨æœåŠ¡**
```bash
docker-compose up -d
```

æœåŠ¡å°†åœ¨ `http://localhost:8088` è¿è¡Œï¼

---

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### API é…ç½®
- **åŸºç¡€ URL**: `http://ä½ çš„æœåŠ¡å™¨IP:8088/v1`
- **API Key**: åœ¨ `.env` ä¸­è®¾ç½®çš„ `API_MASTER_KEY`
- **æ¨¡å‹åç§°**: `gptomni` (æˆ–å…¶ä»–ä»»æ„åç§°)

### æµ‹è¯•è¯·æ±‚
```bash
curl -X POST http://localhost:8088/v1/chat/completions \
-H "Content-Type: application/json" \
-H "Authorization: Bearer sk-your-super-secret-key" \
-d '{
    "model": "gptomni",
    "messages": [
        {
            "role": "user",
            "content": "ä½ å¥½ï¼Œä½ æ˜¯è°ï¼Ÿ"
        }
    ],
    "stream": true
}'
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
gptomni-2api/
â”œâ”€â”€ .env                    # ç¯å¢ƒé…ç½® (ä» .env.example å¤åˆ¶)
â”œâ”€â”€ .env.example           # ç¯å¢ƒé…ç½®æ¨¡æ¿
â”œâ”€â”€ Dockerfile            # Python åº”ç”¨é•œåƒæ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yml    # æœåŠ¡ç¼–æ’é…ç½®
â”œâ”€â”€ main.py              # FastAPI åº”ç”¨å…¥å£
â”œâ”€â”€ nginx.conf           # Nginx åå‘ä»£ç†é…ç½®
â”œâ”€â”€ requirements.txt     # Python ä¾èµ–åˆ—è¡¨
â””â”€â”€ app/                 # æ ¸å¿ƒåº”ç”¨ä»£ç 
    â”œâ”€â”€ core/            # æ ¸å¿ƒé…ç½®æ¨¡å—
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â””â”€â”€ config.py    # é…ç½®ç®¡ç†
    â”œâ”€â”€ providers/       # æœåŠ¡æä¾›è€…æ¨¡å—
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ base_provider.py     # æä¾›è€…åŸºç±»
    â”‚   â”œâ”€â”€ credential_manager.py # å‡­è¯ç®¡ç†
    â”‚   â””â”€â”€ gptomni_provider.py  # GPT-Omni æä¾›è€…
    â””â”€â”€ utils/           # å·¥å…·æ¨¡å—
        â””â”€â”€ sse_utils.py        # SSE å·¥å…·å‡½æ•°
```

---

## ğŸ”¬ æŠ€æœ¯æ¶æ„è¯¦è§£

### å®¹å™¨ç¼–æ’ (`docker-compose.yml`)
- **ä½œç”¨**: å®šä¹‰å’Œç®¡ç†å¤šå®¹å™¨åº”ç”¨
- **æ ¸å¿ƒ**: åè°ƒ Python åº”ç”¨å’Œ Nginx æœåŠ¡
- **æ”¹è¿›å»ºè®®**: æ·»åŠ å¥åº·æ£€æŸ¥æœºåˆ¶

### åå‘ä»£ç† (`nginx.conf`)
- **ä½œç”¨**: è´Ÿè½½å‡è¡¡å’Œæµå¼ä¼ è¾“ä¼˜åŒ–
- **å…³é”®æŠ€æœ¯**: 
  - `upstream` å®šä¹‰åç«¯æœåŠ¡ç»„
  - `proxy_buffering off` å¯ç”¨å®æ—¶æµå¼ä¼ è¾“
- **ä¼˜åŒ–å»ºè®®**: ä½¿ç”¨ `least_conn` è´Ÿè½½å‡è¡¡ç­–ç•¥

### API ç½‘å…³ (`main.py`)
- **æ¡†æ¶**: FastAPI
- **ç‰¹æ€§**: 
  - `lifespan` ç®¡ç†åº”ç”¨ç”Ÿå‘½å‘¨æœŸ
  - `Depends` ä¾èµ–æ³¨å…¥å®ç°èº«ä»½éªŒè¯
- **ä¼˜åŠ¿**: å¼‚æ­¥æ”¯æŒã€è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆ

### é…ç½®ç®¡ç† (`config.py`)
- **æŠ€æœ¯**: `pydantic-settings` 
- **åŠŸèƒ½**: ç¯å¢ƒå˜é‡éªŒè¯å’Œç±»å‹å®‰å…¨
- **äº®ç‚¹**: `@property` å®ç°åŠ¨æ€é…ç½®è§£æ

### å‡­è¯ç®¡ç† (`credential_manager.py`)
- **æ ¸å¿ƒç®—æ³•**: è½®è¯¢ (Round-Robin)
- **çº¿ç¨‹å®‰å…¨**: `threading.Lock` 
- **å¾…å®ç°åŠŸèƒ½**: 
  - å‡­è¯å¥åº·æ£€æŸ¥
  - åŠ¨æ€å‡­è¯çƒ­æ›´æ–°

### GPT-Omni æä¾›è€… (`gptomni_provider.py`)
- **å…³é”®æŠ€æœ¯**:
  - `cloudscraper`: ç»•è¿‡åçˆ¬æœºåˆ¶
  - `aiolimiter`: å¼‚æ­¥é€Ÿç‡é™åˆ¶
  - `StreamingResponse`: æµå¼å“åº”
- **ä¼˜åŒ–æ–¹å‘**: 
  - ç²¾ç»†åŒ–é”™è¯¯å¤„ç†
  - å‚æ•°æ˜ å°„åŠŸèƒ½

### SSE å·¥å…· (`sse_utils.py`)
- **æ ‡å‡†**: Server-Sent Events
- **æ ¼å¼**: `data: {json}\n\n`
- **èŒè´£**: OpenAI å…¼å®¹æ ¼å¼è½¬æ¢

---

## ğŸ“Š åŠŸèƒ½è·¯çº¿å›¾

### âœ… å·²å®ç°åŠŸèƒ½
- [x] æ ¸å¿ƒä»£ç†æœåŠ¡
- [x] å¤šè´¦å·è½®è¯¢æœºåˆ¶  
- [x] Docker å®¹å™¨åŒ–éƒ¨ç½²
- [x] API å¯†é’¥è®¤è¯
- [x] Nginx ç”Ÿäº§ç¯å¢ƒé…ç½®

### ğŸ”„ å¼€å‘ä¸­åŠŸèƒ½
- [ ] å‡­è¯å¥åº·æ£€æŸ¥ç³»ç»Ÿ
- [ ] åŠ¨æ€å‡­è¯ç®¡ç† API
- [ ] ç²¾ç»†åŒ–é”™è¯¯å¤„ç†
- [ ] å®Œæ•´å‚æ•°æ˜ å°„æ”¯æŒ

### ğŸ¯ æœªæ¥è§„åˆ’
- [ ] Prometheus ç›‘æ§é›†æˆ
- [ ] å¤šå¹³å°æ”¯æŒæ‰©å±•
- [ ] Web ç®¡ç†ç•Œé¢
- [ ] Docker Hub å‘å¸ƒ

---

## ğŸ’¡ ä½¿ç”¨åœºæ™¯

### ğŸ¯ ç†æƒ³ç”¨ä¾‹
- **ä¸ªäººå¼€å‘è€…**: åœ¨ä¸ªäººé¡¹ç›®ä¸­é›†æˆ AI èƒ½åŠ›
- **å­¦ä¹ ç ”ç©¶**: å­¦ä¹  API è®¾è®¡å’Œåå‘å·¥ç¨‹
- **ç”Ÿæ€é›†æˆ**: å°† gptomni.ai æ¥å…¥ç°æœ‰ OpenAI ç”Ÿæ€
- **åŸå‹éªŒè¯**: å¿«é€ŸéªŒè¯ AI é©±åŠ¨æƒ³æ³•

### âš ï¸ æ³¨æ„äº‹é¡¹
- **æœåŠ¡ä¾èµ–æ€§**: é¡¹ç›®ä¾èµ–äº gptomni.ai çš„ç¨³å®šæ€§
- **åˆè§„é£é™©**: å¯èƒ½è¿åæœåŠ¡æ¡æ¬¾ï¼Œè¯·ä»…ç”¨äºå­¦ä¹ ç ”ç©¶
- **æŠ€æœ¯é™åˆ¶**: ç›¸æ¯”å®˜æ–¹ API ç¨³å®šæ€§è¾ƒå·®

---

## ğŸ› ï¸ å¼€å‘è´¡çŒ®

æˆ‘ä»¬æ¬¢è¿å„ç§å½¢å¼çš„è´¡çŒ®ï¼

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»º Pull Request
---

**å…è´£å£°æ˜**: æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚ä½¿ç”¨è€…åº”éµå®ˆç›¸å…³ç½‘ç«™çš„æœåŠ¡æ¡æ¬¾ï¼Œå¯¹å› ä½¿ç”¨æœ¬é¡¹ç›®è€Œäº§ç”Ÿçš„ä»»ä½•é—®é¢˜è‡ªè¡Œæ‰¿æ‹…è´£ä»»ã€‚
